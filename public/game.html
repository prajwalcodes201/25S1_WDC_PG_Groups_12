<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trivia Game</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">

  <div class="container mt-5">
    <h2 class="text-center mb-4">Trivia Challenge</h2>

    <div class="text-center mb-3">Time Remaining: <span id="timer">10:00</span></div>

    <div id="questionBox" class="fs-5 fw-bold mb-3">Loading question...</div>
    <ul id="answerList" class="list-group mb-3"></ul>
    <div>Score: <span id="score">0</span></div>
    <div>Question: <span id="qIndex">0</span></div>
  </div>

  <script>
    // 10-minute countdown
    let timeLeft = 10 * 60;
    const timerEl = document.getElementById('timer');

    function updateTimer() {
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    updateTimer();
    const timerInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft < 0) {
        clearInterval(timerInterval);
        alert('Time is up!');
        window.location.href =
          `result.html?score=${score}&total=${questions.length}&difficulty=${difficulty}`;
        return;
      }
      updateTimer();
    }, 1000);

    function decode(str) {
      return decodeURIComponent(escape(atob(str)));
    }

    const params = new URLSearchParams(window.location.search);
    const amount = params.get("amount") || 5;
    const difficulty = params.get("difficulty") || "";
    const type = params.get("type") || "";
    const category = params.get("category") || "";

    // set API URL
    let apiUrl = `/trivia?amount=${amount}`;
    if (difficulty) apiUrl += `&difficulty=${difficulty}`;
    if (type) apiUrl += `&type=${type}`;
    if (category) apiUrl += `&category=${category}`;

    let questions = [];
    let current = 0;
    let score = 0;

    async function startGame() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();

        if (data.response_code !== 0 || !data.results.length) {
          alert("⚠️ Failed to load trivia questions. Please try different settings.");
          window.location.href = "index.html";
          return;
        }

        questions = data.results;
        showQuestion();
      } catch (err) {
        alert("❌ Error fetching questions.");
        console.error(err);
      }
    }

    function showQuestion() {
      if (current >= questions.length) {
        const timeUsed = (10 * 60) - timeLeft;
        window.location.href = `result.html?score=${score}&total=${questions.length}&difficulty=${difficulty}&time=${timeUsed}`;
        return;
      }

      const q = questions[current];
      const questionText = decode(q.question);
      const correct = decode(q.correct_answer);
      const options = q.type === "boolean"
        ? ["True", "False"]
        : [correct, ...q.incorrect_answers.map(decode)].sort(() => Math.random() - 0.5);

      document.getElementById("questionBox").innerText = questionText;
      document.getElementById("qIndex").innerText = current + 1;

      const list = document.getElementById("answerList");
      list.innerHTML = '';
      options.forEach(option => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.innerText = option;
        li.onclick = () => handleAnswer(option, correct);
        list.appendChild(li);
      });
    }

    function handleAnswer(selected, correct) {
      if (selected === correct) {
        score++;
        document.getElementById("score").innerText = score;
      }
      current++;
      showQuestion();
    }

    startGame();
  </script>

</body>
</html>
